<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>å°ä¸­ YouBike 2.0 å°èˆª (TDXä¿®æ­£ç‰ˆ)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; display: flex; flex-direction: column; height: 100vh; background: #f0f2f5; }
    #bar { padding: 12px; background: white; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    #map { flex: 1; width: 100%; }
    #list-container { height: 260px; overflow-y: auto; background: white; border-top: 3px solid #28a745; z-index: 1001; }
    .list-item { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #eee; align-items: center; cursor: pointer; }
    .list-item:active { background: #f1f3f4; }
    .list-name { font-weight: bold; font-size: 16px; color: #333; }
    .bike-num { font-size: 24px; font-weight: bold; }
    button#btn { padding: 10px 20px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .popup-flex { display: flex; align-items: stretch; min-height: 100px; width: 250px; }
    .nav-btn-right { width: 80px; background: #4285f4; color: white !important; display: flex; flex-direction: column; justify-content: center; align-items: center; text-decoration: none; border-left: 1px solid #eee; font-weight: bold; }
  </style>
</head>
<body>
  <div id="bar">
    <button id="btn" onclick="startApp()">ğŸ” å°‹æ‰¾é™„è¿‘ç«™é»</button>
    <div id="status" style="font-size: 12px; color: #666;">ç­‰å¾…å®šä½...</div>
  </div>
  <div id="map"></div>
  <div id="list-container"><div style="padding:40px; text-align:center; color:#999;">å•Ÿå‹•å¾Œè‡ªå‹•é¡¯ç¤º 2km å…§æ’åºæ¸…å–®</div></div>

  <script>
    // ğŸ”´ æ”¹ç”¨ corsproxy.ioï¼Œé€Ÿåº¦é€šå¸¸æ¯”è¼ƒå¿«ä¸”ç©©å®š
    const PROXY = "https://corsproxy.io/?";
    
    const API_AVAIL = "https://tdx.transportdata.tw/api/basic/v2/Bike/Availability/City/Taichung?%24format=JSON";
    const API_STATION = "https://tdx.transportdata.tw/api/basic/v2/Bike/Station/City/Taichung?%24format=JSON";

    let map, userPos, userMarker, stationGroup, markers = {};

    function initMap(lat, lon) {
      if (map) return;
      map = L.map("map", { zoomControl: false }).setView([lat, lon], 16);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: 'Â© OpenStreetMap'
      }).addTo(map);
      stationGroup = L.layerGroup().addTo(map);
    }

    async function startApp() {
      const status = document.getElementById("status");
      status.innerText = "ğŸ“ å®šä½ä¸­...";
      
      navigator.geolocation.getCurrentPosition(async (pos) => {
        userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        initMap(userPos.lat, userPos.lng);
        map.setView([userPos.lat, userPos.lng], 16);

        if (userMarker) userMarker.remove();
        userMarker = L.circleMarker([userPos.lat, userPos.lng], {
          radius: 8, color: 'white', weight: 2, fillColor: '#4285f4', fillOpacity: 1
        }).addTo(map);

        try {
          status.innerText = "ğŸ“¡ é€£ç·šä¸­ (corsproxy)...";
          
          const [stRes, avRes] = await Promise.all([
            fetch(PROXY + encodeURIComponent(API_STATION)),
            fetch(PROXY + encodeURIComponent(API_AVAIL))
          ]);
          
          // ğŸ”´ ä¿®æ­£é»ï¼šcorsproxy æœƒç›´æ¥å›å‚³åŸå§‹ JSONï¼Œä¸éœ€è¦å†è§£ä¸€æ¬¡ .contents
          const stData = await stRes.json();
          const avData = await avRes.json();

          const avMap = {};
          // ç¢ºä¿è³‡æ–™æ˜¯é™£åˆ— (æœ‰æ™‚å€™ TDX éŒ¯èª¤æœƒå›å‚³ç‰©ä»¶)
          if (Array.isArray(avData)) {
            avData.forEach(a => avMap[a.StationUID] = a);
          }

          renderUI(stData, avMap);
          status.innerText = "âœ… æ›´æ–°æˆåŠŸ";
        } catch (err) {
          console.error(err);
          status.innerText = "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
        }
      }, (err) => {
        status.innerText = "âŒ å®šä½å¤±æ•—";
        alert("éœ€è¦å®šä½æ¬Šé™");
      }, { enableHighAccuracy: true, timeout: 10000 });
    }

    function renderUI(stData, avMap) {
      const listEl = document.getElementById("list-container");
      listEl.innerHTML = "";
      stationGroup.clearLayers();

      if (!Array.isArray(stData)) return; // éŒ¯èª¤é˜²è­·

      const nearby = stData.map(s => {
        const av = avMap[s.StationUID] || { AvailableRentBikes: 0 };
        return {
          uid: s.StationUID,
          name: s.StationName.Zh_tw.replace('YouBike2.0_', ''),
          lat: s.StationPosition.PositionLat,
          lng: s.StationPosition.PositionLon,
          bikes: av.AvailableRentBikes,
          dist: map.distance([userPos.lat, userPos.lng], [s.StationPosition.PositionLat, s.StationPosition.PositionLon])
        };
      }).filter(s => s.dist < 2000).sort((a, b) => a.dist - b.dist);

      if (nearby.length === 0) {
        listEl.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">é™„è¿‘ç„¡ç«™é»</div>';
        return;
      }

      nearby.forEach(s => {
        const hex = s.bikes > 5 ? '#28a745' : (s.bikes > 0 ? '#e67e22' : '#dc3545');
        const colorName = s.bikes > 5 ? 'green' : (s.bikes > 0 ? 'orange' : 'red');
        
        const marker = L.marker([s.lat, s.lng], {
          icon: L.icon({
            iconUrl: `https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${colorName}.png`,
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
          })
        }).addTo(stationGroup);

        // ä½¿ç”¨ Google Maps é€šç”¨å”è­°é€£çµ
        const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}&travelmode=walking`;
        
        marker.bindPopup(`
          <div class="popup-flex">
            <div style="padding:15px;flex:1;">
              <b>${s.name}</b><br>
              è»Šè¼›: <span style="color:${hex}; font-weight:bold;">${s.bikes}</span>
            </div>
            <a href="${navUrl}" target="_blank" class="nav-btn-right">ğŸ§­<br>å°èˆª</a>
          </div>
        `);
        markers[s.uid] = marker;

        const item = document.createElement("div");
        item.className = "list-item";
        item.innerHTML = `
          <div>
            <div class="list-name">${s.name}</div>
            <div style="font-size:12px;color:#666;">${Math.round(s.dist)} å…¬å°º</div>
          </div>
          <div class="bike-num" style="color:${hex}">${s.bikes}</div>
        `;
        item.onclick = () => {
          map.flyTo([s.lat, s.lng], 18);
          setTimeout(() => markers[s.uid].openPopup(), 400);
        };
        listEl.appendChild(item);
      });
    }
  </script>
</body>
</html>
