<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ä¸­ YouBike 2.0 å®šä½å°è¦½</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 0; background: #f4f4f4; height: 100vh; display: flex; flex-direction: column; }
        header { background: #ffd306; padding: 10px; text-align: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1001; }
        #status { background: #333; color: white; font-size: 12px; padding: 8px; text-align: center; line-height: 1.4; }
        #map { flex: 1; width: 100%; }
        #list-container { height: 35vh; background: white; overflow-y: auto; border-top: 2px solid #ddd; padding: 10px; z-index: 1001; }
        .station-card { background: #fff; padding: 12px; margin-bottom: 8px; border-radius: 10px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .bike-num { background: #28a745; color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold; min-width: 45px; text-align: center; }
        .bike-empty { background: #dc3545; }
        .dist-text { color: #666; font-size: 12px; margin-top: 4px; }
        .refresh-btn { position: fixed; right: 15px; bottom: 38vh; z-index: 1002; background: #007bff; color: white; border: none; width: 55px; height: 55px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>

<header>ğŸš² å°ä¸­ YouBike 2.0 å³æ™‚åœ°åœ–</header>
<div id="status">æ­£åœ¨å•Ÿå‹•å®šä½...</div>
<div id="map"></div>
<button class="refresh-btn" onclick="init()">ğŸ”„</button>

<div id="list-container">
    <div id="side-list">
        <p style="text-align:center; padding-top:20px; color:gray;">ç­‰å¾…å®šä½èˆ‡è³‡æ–™ä¸‹è¼‰...</p>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // åˆå§‹åŒ–åœ°åœ–
    let map = L.map('map', { zoomControl: false }).setView([24.1373, 120.6869], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    let userMarker, stationGroup = L.layerGroup().addTo(map);

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    async function init() {
        document.getElementById("status").innerText = "GPS å®šä½ä¸­...";
        if (!navigator.geolocation) {
            alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´ GPS å®šä½");
            return;
        }

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            
            map.setView([lat, lng], 16);
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker([lat, lng], { radius: 8, color: '#fff', fillColor: '#007bff', fillOpacity: 1, weight: 2 }).addTo(map);
            
            await fetchBikeData(lat, lng);
        }, (err) => {
            document.getElementById("status").innerText = "å®šä½å¤±æ•—ï¼è«‹æª¢æŸ¥æ‰‹æ©Ÿ GPS æ˜¯å¦é–‹å•ŸåŠ HTTPS é€£ç·š";
            // å®šä½å¤±æ•—ä¾ç„¶å˜—è©¦æŠ“å–è³‡æ–™(é è¨­å°ä¸­ä¸­å¿ƒ)
            fetchBikeData(24.1373, 120.6869);
        }, { enableHighAccuracy: true });
    }

    async function fetchBikeData(uLat, uLng) {
        document.getElementById("status").innerText = "æ­£åœ¨åŒæ­¥ API è³‡æ–™...";
        
        // ä½¿ç”¨ AllOrigins ä»£ç†ï¼Œé€šå¸¸æ¯” corsproxy æ›´ç©©å®š
        const proxy = "https://api.allorigins.win/raw?url=";
        const target = "https://ybjson02.youbike.com.tw:60008/yb2/taichung/gwjs.json";
        
        try {
            const res = await fetch(proxy + encodeURIComponent(target));
            const data = await res.json();
            
            // --- é‡é»ï¼šç›¸å®¹æ€§è§£æ ---
            let rawStations = [];
            // å¦‚æœ data æœ¬èº«å°±æ˜¯é™£åˆ—
            if (Array.isArray(data)) {
                rawStations = data;
            } 
            // å¦‚æœ data æ˜¯ç‰©ä»¶ï¼Œä¸”è³‡æ–™åœ¨ retVal è£¡ (å¯èƒ½æ˜¯ç‰©ä»¶æˆ–é™£åˆ—)
            else if (data && data.retVal) {
                rawStations = Array.isArray(data.retVal) ? data.retVal : Object.values(data.retVal);
            }

            if (rawStations.length === 0) {
                document.getElementById("status").innerText = "æŠ“åˆ°è³‡æ–™ä½†å…§å®¹ç‚ºç©ºï¼Œè«‹ç¨å¾Œå†è©¦";
                return;
            }

            // è½‰æ›èˆ‡æ’åº
            let stations = rawStations
                .filter(s => s.lat && s.lng)
                .map(s => ({
                    ...s,
                    latNum: parseFloat(s.lat),
                    lngNum: parseFloat(s.lng),
                    dist: getDistance(uLat, uLng, parseFloat(s.lat), parseFloat(s.lng))
                }))
                .sort((a, b) => a.dist - b.dist);

            renderUI(stations);
            document.getElementById("status").innerText = `æœ€å¾Œæ›´æ–°ï¼š${new Date().toLocaleTimeString()} (å…± ${stations.length} ç«™)`;
            
        } catch (e) {
            document.getElementById("status").innerText = "é€šè¨ŠéŒ¯èª¤ï¼šç„¡æ³•é€£æ¥ API ä¼ºæœå™¨";
            console.error(e);
        }
    }

    function renderUI(stations) {
        stationGroup.clearLayers();
        const listDiv = document.getElementById("side-list");
        listDiv.innerHTML = "";

        // é¡¯ç¤ºæœ€è¿‘ 30 å€‹åœ¨åœ°åœ–ä¸Š
        stations.slice(0, 30).forEach((s, index) => {
            const isNear = index < 5;
            const marker = L.circleMarker([s.latNum, s.lngNum], {
                radius: isNear ? 10 : 7,
                fillColor: s.sbi > 0 ? "#28a745" : "#dc3545",
                color: "#fff",
                weight: 2,
                fillOpacity: 0.9
            }).addTo(stationGroup);

            marker.bindPopup(`<b>${s.sna.replace('YouBike2.0_', '')}</b><br>å¯å€Ÿï¼š${s.sbi} / å¯é‚„ï¼š${s.bemp}`);

            if (isNear) {
                const card = document.createElement('div');
                card.className = 'station-card';
                card.innerHTML = `
                    <div>
                        <div style="font-weight:bold; color:#333;">${s.sna.replace('YouBike2.0_', '')}</div>
                        <div class="dist-text">ğŸ“ è·é›¢ç´„ ${(s.dist).toFixed(2)} å…¬é‡Œ</div>
                    </div>
                    <div class="bike-num ${s.sbi == 0 ? 'bike-empty' : ''}">${s.sbi}</div>
                `;
                card.onclick = () => {
                    map.setView([s.latNum, s.lngNum], 18);
                    marker.openPopup();
                };
                listDiv.appendChild(card);
            }
        });
    }

    window.onload = init;
</script>
</body>
</html>
