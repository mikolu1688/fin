<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ä¸­ YouBike 2.0 å®˜æ–¹å³æ™‚åœ°åœ–</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        html, body { height: 100%; margin: 0; font-family: "Microsoft JhengHei", sans-serif; }
        .container { display: flex; flex-direction: column; height: 100%; }
        #map { flex: 1; z-index: 1; }
        
        /* åˆ—è¡¨æ¨£å¼ */
        #list-container { height: 45%; overflow-y: auto; background: white; border-top: 3px solid #f9be00; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f9be00; color: #333; position: sticky; top: 0; padding: 12px; z-index: 10; font-size: 1.1em; }
        td { padding: 12px 5px; border-bottom: 1px solid #eee; text-align: center; font-size: 1em; }
        
        /* æ•¸å­—é¡è‰² */
        .available { color: #2e7d32; font-weight: bold; }
        .empty { color: #d32f2f; font-weight: bold; }

        /* å•Ÿå‹•è©¢å•å±¤ */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 9999;
        }
        .start-btn {
            padding: 18px 50px; font-size: 1.3rem; cursor: pointer;
            background: #f9be00; border: none; border-radius: 50px; font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .start-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

<div id="overlay">
    <div style="font-size: 70px; margin-bottom: 20px;">ğŸš²</div>
    <h2 style="margin: 10px;">å°ä¸­ YouBike å³æ™‚åœ°åœ–</h2>
    <p style="color: #666; margin-bottom: 30px;">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ä»¥å…è¨±å–å¾—æ‚¨çš„ä½ç½®<br>æˆ‘å€‘å°‡è‡ªå‹•ç‚ºæ‚¨å°‹æ‰¾æœ€è¿‘çš„ 2.0 ç«™é»</p>
    <button class="start-btn" onclick="startApp()">é–‹å•Ÿå®šä½ä¸¦æŸ¥è©¢</button>
</div>

<div class="container">
    <div id="map"></div>
    <div id="list-container">
        <table>
            <thead>
                <tr>
                    <th style="width: 40%;">ç«™é»åç¨±</th>
                    <th>è·é›¢</th>
                    <th>å¯å€Ÿ</th>
                    <th>å¯é‚„</th>
                </tr>
            </thead>
            <tbody id="bikeList">
                <tr><td colspan="4">è«‹å…ˆå®Œæˆå®šä½æˆæ¬Š...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
// 1. åˆå§‹åŒ–åœ°åœ– (é è¨­å°ä¸­ç«è»Šç«™)
const map = L.map('map').setView([24.1373, 120.6856], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

let userMarker;

// 2. å•Ÿå‹•æŒ‰éˆ•è§¸ç™¼äº‹ä»¶
function startApp() {
    document.getElementById('overlay').style.display = 'none';
    
    // æª¢æŸ¥ç€è¦½å™¨å®šä½æ”¯æ´
    if (!navigator.geolocation) {
        alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚");
        return;
    }

    navigator.geolocation.getCurrentPosition(async (pos) => {
        const uLat = pos.coords.latitude;
        const uLng = pos.coords.longitude;
        
        // æ¨™è¨˜ä½¿ç”¨è€…ä½ç½®
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([uLat, uLng]).addTo(map).bindPopup("<b>ğŸ“ æ‚¨åœ¨é€™è£¡</b>").openPopup();
        map.setView([uLat, uLng], 16);

        // é–‹å§‹æŠ“å–å®˜æ–¹ API è³‡æ–™
        await fetchOfficialBikeData(uLat, uLng);
    }, (err) => {
        alert("å®šä½å¤±æ•—ï¼è«‹ç¢ºä¿å·²é–‹å•Ÿæ‰‹æ©Ÿ/é›»è…¦çš„ GPS æ¬Šé™ï¼Œä¸¦å…è¨±ç€è¦½å™¨å­˜å–ä½ç½®ã€‚");
        document.getElementById('overlay').style.display = 'flex';
    });
}

// 3. æŠ“å–å®˜æ–¹ API ä¸¦è™•ç†
async function fetchOfficialBikeData(uLat, uLng) {
    const tbody = document.getElementById('bikeList');
    tbody.innerHTML = '<tr><td colspan="4">é€£ç·šè‡³ YouBike å®˜æ–¹ä¼ºæœå™¨ä¸­...</td></tr>';

    try {
        // å®˜æ–¹å°ä¸­ 2.0 API ç¶²å€
        const officialUrl = "https://ybjson02.youbike.com.tw:60008/yb2/taichung/gwjs.json";
        
        // ä½¿ç”¨ corsproxy.io è§£æ±º GitHub Pages çš„è·¨ç¶²åŸŸæ””æˆªå•é¡Œ
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(officialUrl)}`;

        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error("å®˜æ–¹ä¼ºæœå™¨å›æ‡‰ç•°å¸¸");
        
        const rawData = await response.json();
        
        // å®˜æ–¹ JSON æ ¼å¼ï¼šç«™é»è³‡æ–™ä½æ–¼ retVal ç‰©ä»¶ä¸­
        const data = rawData.retVal;

        // å°‡ç‰©ä»¶è½‰ç‚ºé™£åˆ—ä¸¦è¨ˆç®—è·é›¢ã€æ’åº
        const stations = Object.keys(data).map(key => {
            const s = data[key];
            const sLat = parseFloat(s.lat);
            const sLng = parseFloat(s.lng);
            return {
                name: s.sna.replace("YouBike2.0_", ""),
                lat: sLat,
                lng: sLng,
                available: parseInt(s.sbi), // å¯å€Ÿè»Šæ•¸
                empty: parseInt(s.bemp),    // å¯é‚„ç©ºä½
                distance: calcDistance(uLat, uLng, sLat, sLng)
            };
        })
        .sort((a, b) => a.distance - b.distance) // ä¾è·é›¢æ’åº
        .slice(0, 30); // é¡¯ç¤ºæœ€è¿‘ 30 å€‹ç«™é»

        // æ¸²æŸ“åˆ—è¡¨èˆ‡åœ°åœ–æ¨™è¨˜
        tbody.innerHTML = "";
        stations.forEach(s => {
            // åœ°åœ–æ¨™è¨˜
            L.marker([s.lat, s.lng]).addTo(map)
                .bindPopup(`<b>${s.name}</b><br>ğŸš² å¯å€Ÿï¼š${s.available}<br>ğŸ…¿ï¸ å¯é‚„ï¼š${s.empty}`);

            // åˆ—è¡¨åˆ—
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align:left; padding-left:10px;">${s.name}</td>
                <td>${Math.round(s.distance)}m</td>
                <td class="${s.available > 0 ? 'available' : 'empty'}">${s.available}</td>
                <td>${s.empty}</td>
            `;
            tbody.appendChild(tr);
        });

    } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="4" style="color:red; padding:20px;">è³‡æ–™è®€å–å¤±æ•—ï¼<br>è«‹ç¢ºèªç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚</td></tr>';
    }
}

// 4. è·é›¢è¨ˆç®—å‡½å¼ (Haversine Formula)
function calcDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // åœ°çƒåŠå¾‘ (å…¬å°º)
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
</script>
</body>
</html>
