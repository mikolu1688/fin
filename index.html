<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ä¸­ YouBike 2.0 å®šä½å°è¦½</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 0; background: #f4f4f4; height: 100vh; display: flex; flex-direction: column; }
        header { background: #ffd306; padding: 10px; text-align: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1001; }
        #status { background: #333; color: white; font-size: 12px; padding: 5px; text-align: center; }
        #map { flex: 1; width: 100%; }
        #list-container { height: 35vh; background: white; overflow-y: auto; border-top-left-radius: 15px; border-top-right-radius: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding: 10px; z-index: 1001; }
        .station-card { background: #fff; padding: 12px; margin-bottom: 8px; border-radius: 10px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .station-card:active { background: #f0f0f0; }
        .bike-num { background: #28a745; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; }
        .bike-empty { background: #dc3545; }
        .dist-text { color: #666; font-size: 12px; margin-top: 4px; }
        .refresh-btn { position: fixed; right: 15px; bottom: 38vh; z-index: 1002; background: white; border: none; width: 50px; height: 50px; border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>

<header>ğŸš² å°ä¸­ YouBike 2.0 æ‰¾æ‰¾è»Š</header>
<div id="status">æ­£åœ¨åˆå§‹åŒ– GPS...</div>
<div id="map"></div>
<button class="refresh-btn" onclick="init()">ğŸ”„</button>

<div id="list-container">
    <div id="side-list">
        <p style="text-align:center; padding-top:20px; color:gray;">æ­£åœ¨å°‹æ‰¾é™„è¿‘ç«™é»...</p>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // åˆå§‹åŒ–åœ°åœ– (é è¨­å°ä¸­ç«è»Šç«™)
    let map = L.map('map', { zoomControl: false }).setView([24.1373, 120.6869], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    let userMarker, stationGroup = L.layerGroup().addTo(map);

    // å“ˆå¼—è¾›å…¬å¼ï¼šè¨ˆç®—åœ°çƒä¸Šå…©é»è·é›¢
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    async function init() {
        document.getElementById("status").innerText = "æ­£åœ¨å–å¾—æ‚¨çš„ä½ç½®...";
        
        if (!navigator.geolocation) {
            document.getElementById("status").innerText = "æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½";
            return;
        }

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            
            // æ›´æ–°åœ°åœ–ä¸Šçš„å€‹äººåº§æ¨™
            map.setView([lat, lng], 16);
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker([lat, lng], { radius: 8, color: '#007bff', fillColor: '#007bff', fillOpacity: 1 }).addTo(map).bindPopup("ä½ çš„ä½ç½®");
            
            await fetchBikeData(lat, lng);
        }, (err) => {
            document.getElementById("status").innerText = "å®šä½å¤±æ•—ï¼Œè«‹ç¢ºèªé–‹å•Ÿ GPS ä¸¦ä½¿ç”¨ HTTPS é€£ç·š";
        }, { enableHighAccuracy: true });
    }

    async function fetchBikeData(uLat, uLng) {
        document.getElementById("status").innerText = "æ­£åœ¨é€£ç·š YouBike ä¼ºæœå™¨...";
        
        // ä½¿ç”¨ corsproxy.io è§£æ±ºæ‰‹æ©Ÿç‰ˆ CORS é™åˆ¶å•é¡Œ
        const proxy = "https://corsproxy.io/?";
        const target = "https://ybjson02.youbike.com.tw:60008/yb2/taichung/gwjs.json";
        
        try {
            const res = await fetch(proxy + encodeURIComponent(target));
            const data = await res.json();
            
            // è™•ç†ä¸åŒæ ¼å¼çš„è³‡æ–™
            const rawStations = Array.isArray(data) ? data : (data.retVal || []);
            
            // è¨ˆç®—è·é›¢ä¸¦æ’åº
            let stations = rawStations.map(s => ({
                ...s,
                dist: getDistance(uLat, uLng, parseFloat(s.lat), parseFloat(s.lng))
            })).sort((a, b) => a.dist - b.dist);

            renderUI(stations);
            document.getElementById("status").innerText = `æˆåŠŸæ›´æ–°è³‡æ–™ (${new Date().toLocaleTimeString()})`;
        } catch (e) {
            document.getElementById("status").innerText = "è³‡æ–™æŠ“å–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†";
            console.error(e);
        }
    }

    function renderUI(stations) {
        stationGroup.clearLayers();
        const listDiv = document.getElementById("side-list");
        listDiv.innerHTML = "";

        // åªè™•ç†å‰ 30 å€‹ç«™é»é¿å…æ‰‹æ©Ÿå¡é “
        stations.slice(0, 30).forEach((s, index) => {
            const isNear = index < 5; // å‰ 5 å€‹é¡¯ç¤ºåœ¨åˆ—è¡¨ä¸¦é‡é»æ¨™è¨»
            
            // åœ°åœ–æ¨™è¨˜
            const marker = L.circleMarker([s.lat, s.lng], {
                radius: isNear ? 10 : 6,
                fillColor: s.sbi > 0 ? "#28a745" : "#dc3545",
                color: "#fff",
                weight: 2,
                fillOpacity: 0.8
            }).addTo(stationGroup).bindPopup(`<b>${s.sna.replace('YouBike2.0_', '')}</b><br>å¯å€Ÿï¼š${s.sbi} å°`);

            // åˆ—è¡¨å¡ç‰‡ (åƒ…é¡¯ç¤ºæœ€è¿‘ 5 å€‹)
            if (isNear) {
                const card = document.createElement('div');
                card.className = 'station-card';
                card.innerHTML = `
                    <div>
                        <div style="font-weight:bold">${s.sna.replace('YouBike2.0_', '')}</div>
                        <div class="dist-text">ğŸ“ è·é›¢ ${s.dist.toFixed(2)} km</div>
                    </div>
                    <div class="bike-num ${s.sbi == 0 ? 'bike-empty' : ''}">${s.sbi} å°</div>
                `;
                card.onclick = () => {
                    map.setView([s.lat, s.lng], 18);
                    marker.openPopup();
                };
                listDiv.appendChild(card);
            }
        });
    }

    // è‡ªå‹•åŸ·è¡Œ
    window.onload = init;
</script>

</body>
</html>
