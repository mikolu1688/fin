<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ä¸­ YouBike 2.0 å³æ™‚åœ°åœ–</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        html, body { height: 100%; margin: 0; font-family: sans-serif; }
        .container { display: flex; flex-direction: column; height: 100%; }
        #map { flex: 1; z-index: 1; }
        #list-container { height: 40%; overflow-y: auto; background: white; border-top: 3px solid #f9be00; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f9be00; color: #333; position: sticky; top: 0; padding: 12px; z-index: 10; }
        td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: center; }
        .available { color: #2e7d32; font-weight: bold; }
        .empty { color: #d32f2f; font-weight: bold; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .start-btn { padding: 15px 40px; font-size: 1.2rem; cursor: pointer; background: #f9be00; border: none; border-radius: 50px; font-weight: bold; }
    </style>
</head>
<body>

<div id="overlay">
    <div style="font-size: 60px;">ğŸš²</div>
    <h2>å°ä¸­ YouBike 2.0 å³æ™‚æŸ¥è©¢</h2>
    <button class="start-btn" onclick="startApp()">é–‹å•Ÿå®šä½ä¸¦æŸ¥è©¢</button>
</div>

<div class="container">
    <div id="map"></div>
    <div id="list-container">
        <table>
            <thead>
                <tr><th>ç«™é»åç¨±</th><th>è·é›¢</th><th>å¯å€Ÿ</th><th>å¯é‚„</th></tr>
            </thead>
            <tbody id="bikeList"></tbody>
        </table>
    </div>
</div>

<script>
const map = L.map('map').setView([24.1373, 120.6856], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

function startApp() {
    document.getElementById('overlay').style.display = 'none';
    navigator.geolocation.getCurrentPosition(async (pos) => {
        const uLat = pos.coords.latitude;
        const uLng = pos.coords.longitude;
        map.setView([uLat, uLng], 16);
        L.marker([uLat, uLng]).addTo(map).bindPopup("æ‚¨çš„ä½ç½®").openPopup();
        await fetchWithRetry(uLat, uLng);
    }, () => alert("å®šä½å¤±æ•—ï¼Œè«‹ç¢ºä¿ä½¿ç”¨ HTTPS ä¸¦é–‹å•Ÿ GPS"));
}

async function fetchWithRetry(uLat, uLng) {
    const tbody = document.getElementById('bikeList');
    tbody.innerHTML = '<tr><td colspan="4">æ­£åœ¨åˆ‡æ›ä»£ç†ä¼ºæœå™¨ä¸­...</td></tr>';

    const targetUrl = "https://ybjson02.youbike.com.tw:60008/yb2/taichung/gwjs.json";
    
    // å®šç¾©å¤šå€‹ä»£ç†æœå‹™
    const proxies = [
        url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
        url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
        url => `https://thingproxy.freeboard.io/fetch/${url}`
    ];

    for (let getProxyUrl of proxies) {
        try {
            const res = await fetch(getProxyUrl(targetUrl));
            if (!res.ok) throw new Error();

            const json = await res.json();
            // AllOrigins éœ€è¦è§£æ json.contents
            const rawData = typeof json.contents === 'string' ? JSON.parse(json.contents) : (json.retVal || json);
            const data = rawData.retVal || rawData;

            renderData(data, uLat, uLng);
            return; // æˆåŠŸå³åœæ­¢
        } catch (e) {
            console.warn("ç›®å‰ä»£ç†å¤±æ•ˆï¼Œå˜—è©¦ä¸‹ä¸€å€‹...");
        }
    }
    tbody.innerHTML = '<tr><td colspan="4" style="color:red">é€£ç·šå¤±æ•—ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚</td></tr>';
}

function renderData(data, uLat, uLng) {
    const tbody = document.getElementById('bikeList');
    tbody.innerHTML = "";
    
    const stations = Object.keys(data).map(k => {
        const s = data[k];
        const sLat = parseFloat(s.lat), sLng = parseFloat(s.lng);
        return {
            name: s.sna.replace("YouBike2.0_", ""),
            lat: sLat, lng: sLng,
            sbi: parseInt(s.sbi), bemp: parseInt(s.bemp),
            dist: calcDist(uLat, uLng, sLat, sLng)
        };
    }).sort((a, b) => a.dist - b.dist).slice(0, 25);

    stations.forEach(s => {
        L.marker([s.lat, s.lng]).addTo(map).bindPopup(`<b>${s.name}</b><br>ğŸš²ï¼š${s.sbi}`);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.name}</td><td>${Math.round(s.dist)}m</td><td class="${s.sbi > 0 ? 'available' : 'empty'}">${s.sbi}</td><td>${s.bemp}</td>`;
        tbody.appendChild(tr);
    });
}

function calcDist(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
</script>
</body>
</html>
