<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é™„è¿‘ YouBike å³æ™‚ç«™é»æŸ¥è©¢</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html, body { height: 100%; margin: 0; font-family: "Microsoft JhengHei", sans-serif; }
  .container { display: flex; flex-direction: column; height: 100%; }
  #map { flex: 1; min-height: 300px; }
  #list-container { height: 40%; overflow-y: auto; background: white; border-top: 2px solid #ddd; }
  table { width: 100%; border-collapse: collapse; }
  th { background: #ffef00; color: #333; position: sticky; top: 0; padding: 10px; z-index: 1000; }
  td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: center; }
  tr:nth-child(even) { background: #fafafa; }
  .status-tag { padding: 2px 6px; border-radius: 4px; font-size: 0.9em; font-weight: bold; }
  .available { color: #2e7d32; } /* ç¶ è‰²ï¼šé‚„æœ‰è»Š */
  .empty { color: #d32f2f; }    /* ç´…è‰²ï¼šæ²’è»Š */
</style>
</head>

<body>
<div class="container">
  <div id="map"></div>
  <div id="list-container">
    <table>
      <thead>
        <tr>
          <th>ç«™å</th>
          <th>è·é›¢</th>
          <th>å¯å€Ÿ</th>
          <th>å¯é‚„</th>
        </tr>
      </thead>
      <tbody id="bikeList">
        <tr><td colspan="4">æ­£åœ¨å–å¾—æ‚¨çš„å®šä½...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
// è¨ˆç®—è·é›¢ (Haversine formula)
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000; 
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// åˆå§‹åŒ–åœ°åœ– (é è¨­å°åŒ—å¸‚æ”¿åºœ)
const map = L.map('map').setView([25.0330, 121.5654], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

// å–å¾—ä½¿ç”¨è€…å®šä½
navigator.geolocation.getCurrentPosition(async (pos) => {
  const userLat = pos.coords.latitude;
  const userLng = pos.coords.longitude;

  // æ¨™è¨˜ä½¿ç”¨è€…ä½ç½®
  L.marker([userLat, userLng]).addTo(map).bindPopup("<b>ğŸ“ ä½ åœ¨é€™è£¡</b>").openPopup();
  map.setView([userLat, userLng], 16);

  try {
    // å‘¼å«å°åŒ—å¸‚æ”¿åºœ YouBike 2.0 å³æ™‚è³‡æ–™ API
    const response = await fetch("https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json");
    if (!response.ok) throw new Error("ç„¡æ³•å–å¾— API è³‡æ–™");
    
    const data = await response.json();

    // 1. è¨ˆç®—è·é›¢ä¸¦å­˜å…¥é™£åˆ—
    const sortedData = data.map(station => ({
      name: station.sna.replace("YouBike2.0_", ""),
      lat: station.lat,
      lng: station.lng,
      available: station.sbi, // å¯å€Ÿè»Šè¼›
      empty: station.bemp,    // å¯é‚„ç©ºä½
      distance: getDistance(userLat, userLng, station.lat, station.lng)
    }))
    .sort((a, b) => a.distance - b.distance) // 2. ä¾è·é›¢æ’åº
    .slice(0, 20); // 3. åªå–æœ€è¿‘ 20 ç«™ï¼Œæ•ˆèƒ½è¼ƒå¥½

    const tbody = document.getElementById("bikeList");
    tbody.innerHTML = "";

    sortedData.forEach(station => {
      // åœ¨åœ°åœ–ä¸Šæ¨™è¨˜
      const markerColor = station.available > 0 ? "blue" : "red";
      L.marker([station.lat, station.lng]).addTo(map)
        .bindPopup(`<b>${station.name}</b><br>å¯å€Ÿï¼š${station.available}<br>å¯é‚„ï¼š${station.empty}`);

      // å¡«å……åˆ—è¡¨
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="text-align:left;">${station.name}</td>
        <td>${Math.round(station.distance)}m</td>
        <td class="status-tag ${station.available > 0 ? 'available' : 'empty'}">${station.available}</td>
        <td>${station.empty}</td>
      `;
      tbody.appendChild(tr);
    });

  } catch (error) {
    console.error(error);
    document.getElementById("bikeList").innerHTML = `<tr><td colspan="4">è³‡æ–™è®€å–å¤±æ•—</td></tr>`;
  }

}, (err) => {
  alert("è«‹é–‹å•Ÿ GPS å®šä½æˆæ¬Šï¼Œå¦å‰‡ç„¡æ³•è¨ˆç®—è·é›¢ã€‚");
});
</script>
</body>
</html>
