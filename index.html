<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouBike 2.0 è¿‘ç«™æŸ¥è©¢ (TDX API ç‰ˆ)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        html, body { height: 100%; margin: 0; font-family: sans-serif; }
        .container { display: flex; flex-direction: column; height: 100%; }
        #map { flex: 1; }
        #list-container { height: 40%; overflow-y: auto; background: white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
        th { background: #f8f8f8; position: sticky; top: 0; }
        
        /* è©¢å•å±¤æ¨£å¼ */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); color: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999;
        }
        button {
            padding: 15px 30px; font-size: 1.2em; cursor: pointer;
            background: #ffef00; border: none; border-radius: 5px; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="overlay">
    <h2>ğŸš² é™„è¿‘ YouBike æŸ¥è©¢</h2>
    <p>æˆ‘å€‘éœ€è¦å–å¾—æ‚¨çš„ä½ç½®ä»¥å°‹æ‰¾æœ€è¿‘çš„ç«™é»</p>
    <button onclick="startApp()">åŒæ„ä¸¦å–å¾—å®šä½</button>
</div>

<div class="container">
    <div id="map"></div>
    <div id="list-container">
        <table>
            <thead>
                <tr>
                    <th>ç«™å</th>
                    <th>è·é›¢</th>
                    <th>å¯å€Ÿ</th>
                    <th>å¯é‚„</th>
                </tr>
            </thead>
            <tbody id="bikeList"></tbody>
        </table>
    </div>
</div>

<script>
// --- è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„ TDX API é‡‘é‘° ---
const CLIENT_ID = 'YOUR_CLIENT_ID'; 
const CLIENT_SECRET = 'YOUR_CLIENT_SECRET';
// ------------------------------

let userLat, userLng;
const map = L.map('map').setView([25.0330, 121.5654], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// 1. é»æ“ŠæŒ‰éˆ•å¾Œé–‹å§‹åŸ·è¡Œ
function startApp() {
    document.getElementById('overlay').style.display = 'none';
    
    if (!navigator.geolocation) {
        alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
        return;
    }

    navigator.geolocation.getCurrentPosition(async (pos) => {
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;
        
        // è¨­å®šåœ°åœ–ä¸­å¿ƒ
        L.marker([userLat, userLng]).addTo(map).bindPopup("æ‚¨çš„ä½ç½®").openPopup();
        map.setView([userLat, userLng], 16);

        await initBikeData();
    }, (err) => {
        alert("å®šä½å¤±æ•—ï¼Œè«‹ç¢ºä¿å·²é–‹å•Ÿ GPS ä¸¦æˆæ¬Šç¶²é å­˜å–ä½ç½®ã€‚");
        document.getElementById('overlay').style.display = 'flex';
    });
}

// 2. å–å¾— TDX Access Token (å› ç‚º API è¦æ±‚é©—è­‰)
async function getAccessToken() {
    const url = "https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token";
    const params = new URLSearchParams();
    params.append('grant_type', 'client_credentials');
    params.append('client_id', CLIENT_ID);
    params.append('client_secret', CLIENT_SECRET);

    const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params
    });
    const data = await response.json();
    return data.access_token;
}

// 3. ç²å–è³‡æ–™ä¸¦æ¸²æŸ“
async function initBikeData() {
    try {
        const token = await getAccessToken();
        const tbody = document.getElementById('bikeList');
        tbody.innerHTML = '<tr><td colspan="4">è³‡æ–™åŠ è¼‰ä¸­...</td></tr>';

        // å‘¼å« TDX API (å°åŒ—å¸‚ YouBike 2.0 ç«™é»èˆ‡å³æ™‚è³‡æ–™)
        // é€™è£¡ä½¿ç”¨ $top=30 ä¸¦æ­é…è·é›¢æ’åºé‚è¼¯
        const url = `https://tdx.transportdata.tw/api/basic/v2/Bike/Availability/City/Taipei?$format=JSON`;
        
        const res = await fetch(url, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const availData = await res.json();

        // ç«™é»ä½ç½®è³‡è¨Š (é€šå¸¸éœ€è¦å°æ¥ï¼Œä½† TDX V2 Availability å·²åŒ…å«éƒ¨åˆ†åŸºç¤è³‡è¨Š)
        // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘è¨ˆç®—è·é›¢ä¸¦æ’åº
        const sortedData = availData.map(station => {
            const d = getDistance(userLat, userLng, station.StationPosition.PositionLat, station.StationPosition.PositionLon);
            return { ...station, distance: d };
        })
        .sort((a, b) => a.distance - b.distance)
        .slice(0, 20); // å–æœ€è¿‘ 20 ç«™

        tbody.innerHTML = "";
        sortedData.forEach(station => {
            const name = station.StationName.Zh_tw.replace("YouBike2.0_", "");
            
            // åœ°åœ–æ¨™è¨˜
            L.marker([station.StationPosition.PositionLat, station.StationPosition.PositionLon])
                .addTo(map)
                .bindPopup(`<b>${name}</b><br>å¯å€Ÿï¼š${station.AvailableRentBikes}<br>å¯é‚„ï¼š${station.AvailableReturnSlots}`);

            // è¡¨æ ¼æ¸²æŸ“
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${name}</td>
                <td>${Math.round(station.distance)}m</td>
                <td style="color:${station.AvailableRentBikes > 0 ? 'green' : 'red'}">${station.AvailableRentBikes}</td>
                <td>${station.AvailableReturnSlots}</td>
            `;
            tbody.appendChild(tr);
        });

    } catch (err) {
        console.error(err);
        alert("API è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Client ID/Secret æ˜¯å¦æ­£ç¢ºã€‚");
    }
}

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
</script>
</body>
</html>
