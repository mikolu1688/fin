<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>å°ä¸­ YouBike 2.0 å®šä½å°èˆª</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; display: flex; flex-direction: column; height: 100vh; }
    #bar { padding: 12px; background: white; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    #map { flex: 1; width: 100%; }
    #list-container { height: 260px; overflow-y: auto; background: white; border-top: 3px solid #28a745; z-index: 1001; }
    .list-item { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #eee; align-items: center; cursor: pointer; }
    .list-name { font-weight: bold; font-size: 16px; }
    .bike-num { font-size: 22px; font-weight: bold; }
    button#btn { padding: 10px 20px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    
    /* å½ˆçª—ï¼šå³æ‰‹å¤§æ‹‡æŒ‡å‹å–„å°èˆª */
    .leaflet-popup-content-wrapper { padding: 0; overflow: hidden; border-radius: 12px; }
    .leaflet-popup-content { margin: 0; width: 260px !important; }
    .popup-flex { display: flex; align-items: stretch; min-height: 100px; }
    .popup-info { flex: 1; padding: 15px; display: flex; flex-direction: column; justify-content: center; }
    .nav-btn-right { width: 85px; background: #4285f4; color: white !important; display: flex; flex-direction: column; justify-content: center; align-items: center; text-decoration: none; border-left: 1px solid #eee; }
  </style>
</head>
<body>
  <div id="bar">
    <button id="btn" onclick="startApp()">ğŸ” åˆ·æ–°é™„è¿‘å–®è»Š</button>
    <div id="status" style="font-size: 12px; color: #666;">ç­‰å¾…å®šä½...</div>
  </div>
  <div id="map"></div>
  <div id="list-container"><div style="padding:40px; text-align:center; color:#999;">å•Ÿå‹•å¾Œå°‡åœ¨æ­¤é¡¯ç¤ºé™„è¿‘ç«™é»æ¸…å–®</div></div>

  <script>
    // è§£æ±º 403 æ ¸å¿ƒï¼šç›´æ¥ä½¿ç”¨å®˜æ–¹ JSONP æª”æ¡ˆ
    const API_URL = "https://ybjson02.youbike.com.tw:60008/yb2/taichung/gwjs.json";
    let map, userPos, userMarker, stationGroup, markers = {};

    function initMap(lat, lon) {
      if (map) return;
      map = L.map("map", { zoomControl: false }).setView([lat, lon], 16);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
      stationGroup = L.layerGroup().addTo(map);
    }

    // åˆ©ç”¨ <script> æ¨™ç±¤ç¹é CORS èˆ‡ 403 é˜»æ“‹
    function loadYouBikeData() {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = `${API_URL}?t=${Date.now()}`;
        script.onload = () => {
          if (typeof gwjs !== 'undefined') resolve(gwjs.retVal);
          else reject("è³‡æ–™æ ¼å¼ä¸ç¬¦");
        };
        script.onerror = () => reject("é€£ç·šè¶…æ™‚ (Port 60008 è¢«æ“‹)");
        document.body.appendChild(script);
      });
    }

    async function startApp() {
      const status = document.getElementById("status");
      status.innerText = "ğŸ›°ï¸ å®šä½ä¸­...";
      
      navigator.geolocation.getCurrentPosition(async (pos) => {
        userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        initMap(userPos.lat, userPos.lng);
        map.setView([userPos.lat, userPos.lng], 16);

        if (userMarker) userMarker.remove();
        userMarker = L.circleMarker([userPos.lat, userPos.lng], { radius: 8, color: 'white', weight: 2, fillColor: '#4285f4', fillOpacity: 1 }).addTo(map);

        try {
          status.innerText = "ğŸš² æ›´æ–°è»Šä½ä¸­...";
          const stations = await loadYouBikeData();
          renderUI(stations);
          status.innerText = "æœ€å¾Œæ›´æ–°: " + new Date().toLocaleTimeString();
        } catch (err) {
          status.innerText = "âŒ " + err;
        }
      }, () => { status.innerText = "âŒ å®šä½å¤±æ•—"; }, { enableHighAccuracy: true });
    }

    function renderUI(stations) {
      const listEl = document.getElementById("list-container");
      listEl.innerHTML = "";
      stationGroup.clearLayers();

      // è¨ˆç®—è·é›¢ä¸¦æ’åºæ¸…å–® (ç”±è¿‘åˆ°é )
      const nearby = Object.values(stations).map(s => ({
        ...s,
        dist: map.distance([userPos.lat, userPos.lng], [parseFloat(s.lat), parseFloat(s.lng)])
      })).filter(s => s.dist < 2000).sort((a, b) => a.dist - b.dist);

      nearby.forEach(s => {
        const bikes = parseInt(s.sbi);
        const hex = bikes > 5 ? '#28a745' : (bikes > 0 ? '#e67e22' : '#dc3545');
        const colorName = bikes > 5 ? 'green' : (bikes > 0 ? 'orange' : 'red');

        // åœ°åœ–æ¨™è¨˜
        const marker = L.marker([parseFloat(s.lat), parseFloat(s.lng)], {
          icon: L.icon({
            iconUrl: `https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${colorName}.png`,
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
          })
        }).addTo(stationGroup);

        marker.bindPopup(`
          <div class="popup-flex">
            <div class="popup-info">
              <b>${s.sna.replace('YouBike2.0_', '')}</b><br>
              <span style="color:${hex}; font-size:16px;">å¯å€Ÿ: ${s.sbi}</span>
            </div>
            <a href="https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}&travelmode=walking" target="_blank" class="nav-btn-right">ğŸ§­<br>å°èˆª</a>
          </div>
        `);
        markers[s.sno] = marker;

        // ä¸‹æ–¹æ¸…å–®
        const item = document.createElement("div");
        item.className = "list-item";
        item.innerHTML = `
          <div>
            <div class="list-name">${s.sna.replace('YouBike2.0_', '')}</div>
            <div style="font-size:12px; color:#666;">è·é›¢ ${Math.round(s.dist)}m | ç©ºä½ ${s.bemp}</div>
          </div>
          <div class="bike-num" style="color:${hex}">${s.sbi}</div>
        `;
        item.onclick = () => {
          map.flyTo([parseFloat(s.lat), parseFloat(s.lng)], 18);
          setTimeout(() => markers[s.sno].openPopup(), 400);
        };
        listEl.appendChild(item);
      });
    }
  </script>
</body>
</html>
