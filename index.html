<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é™„è¿‘ YouBike æ¸…å–® </title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: Arial, sans-serif;
}

.container {
  display: flex;
  height: 100%;
}

#map {
  flex: 2;
}

#list {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  background: #f4f4f4;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 6px;
  border-bottom: 1px solid #ccc;
  text-align: center;
}

th {
  background: #e0f2f1;
}
</style>
</head>

<body>
<div class="container">
  <div id="map"></div>
  <div id="list">
    <h3>ğŸš² é™„è¿‘ YouBikeï¼ˆæœ€å¤šé¡¯ç¤º 5 ç«™ï¼‰</h3>
    <table>
      <thead>
        <tr>
          <th>ç«™å</th>
          <th>è·é›¢(m)</th>
          <th>å¯å€Ÿ</th>
          <th>å¯é‚„</th>
        </tr>
      </thead>
      <tbody id="bikeList"></tbody>
    </table>
  </div>
</div>

<script>
/* è·é›¢è¨ˆç®— */
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* åœ°åœ– */
const map = L.map('map').setView([25.0330, 121.5654], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

/* å®šä½ */
navigator.geolocation.getCurrentPosition(pos => {
  const userLat = pos.coords.latitude;
  const userLng = pos.coords.longitude;

  L.marker([userLat, userLng])
    .addTo(map)
    .bindPopup("ğŸ“ ä½ çš„ä½ç½®")
    .openPopup();

  map.setView([userLat, userLng], 14);

  fetch("https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json")
    .then(res => res.json())
    .then(data => {

      // è¨ˆç®—è·é›¢ä¸¦æ’åº
      const nearby = data.map(station => ({
        ...station,
        distance: getDistance(userLat, userLng, station.lat, station.lng)
      }))
      .sort((a, b) => a.distance - b.distance)
      .slice(0, 5); // ğŸ‘‰ ä¸€å®šé¡¯ç¤ºæœ€è¿‘ 5 ç«™

      const tbody = document.getElementById("bikeList");

      nearby.forEach(station => {

        // åœ°åœ–
        L.marker([station.lat, station.lng])
          .addTo(map)
          .bindPopup(`
            <b>${station.sna}</b><br>
            è·é›¢ ${station.distance.toFixed(0)} å…¬å°º
          `);

        // è¡¨å–®
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${station.sna}</td>
          <td>${station.distance.toFixed(0)}</td>
          <td>${station.sbi}</td>
          <td>${station.bemp}</td>
        `;
        tbody.appendChild(tr);
      });

    });

}, () => {
  alert("è«‹å…è¨±å®šä½æ¬Šé™");
});
</script>
</body>
</html>
