<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ä¸­ YouBike 2.0 å³æ™‚åœ°åœ–</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 0; background: #f4f4f4; height: 100vh; display: flex; flex-direction: column; }
        header { background: #ffd306; padding: 10px; text-align: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1001; }
        #status { background: #333; color: white; font-size: 12px; padding: 8px; text-align: center; line-height: 1.4; }
        #map { flex: 1; width: 100%; }
        #list-container { height: 35vh; background: white; overflow-y: auto; border-top: 2px solid #ddd; padding: 10px; z-index: 1001; }
        .station-card { background: #fff; padding: 12px; margin-bottom: 8px; border-radius: 10px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .bike-num { background: #28a745; color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold; min-width: 45px; text-align: center; }
        .bike-empty { background: #dc3545; }
        .dist-text { color: #666; font-size: 12px; margin-top: 4px; }
        .refresh-btn { position: fixed; right: 15px; bottom: 38vh; z-index: 1002; background: #007bff; color: white; border: none; width: 55px; height: 55px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>

<header>ğŸš² å°ä¸­ YouBike 2.0 æ‰¾æ‰¾è»Š</header>
<div id="status">æ­£åœ¨å•Ÿå‹•å®šä½...</div>
<div id="map"></div>
<button class="refresh-btn" onclick="init()">ğŸ”„</button>

<div id="list-container">
    <div id="side-list">
        <p style="text-align:center; padding-top:20px; color:gray;">ç­‰å¾…å®šä½èˆ‡è³‡æ–™ä¸‹è¼‰...</p>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. åˆå§‹åŒ–åœ°åœ– (é è¨­ä½ç½®ç‚ºå°ä¸­ç«è»Šç«™)
    let map = L.map('map', { zoomControl: false }).setView([24.1373, 120.6869], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    let userMarker, stationGroup = L.layerGroup().addTo(map);

    // è¨ˆç®—è·é›¢çš„ Haversine å…¬å¼
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // 2. åˆå§‹åŒ–å®šä½èˆ‡è³‡æ–™æŠ“å–
    async function init() {
        document.getElementById("status").innerText = "GPS å®šä½ä¸­...";
        if (!navigator.geolocation) {
            alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´ GPS å®šä½");
            return;
        }

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            
            // æ›´æ–°åœ°åœ–ä¸­å¿ƒèˆ‡å€‹äººæ¨™è¨˜
            map.setView([lat, lng], 16);
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker([lat, lng], { radius: 8, color: '#fff', fillColor: '#007bff', fillOpacity: 1, weight: 2 }).addTo(map);
            
            await fetchBikeData(lat, lng);
        }, (err) => {
            document.getElementById("status").innerText = "å®šä½å¤±æ•—ï¼è«‹é–‹å•Ÿ GPS ä¸¦ä½¿ç”¨ HTTPS ç€è¦½";
            // è‹¥å®šä½å¤±æ•—ï¼Œä»å˜—è©¦æŠ“å–è³‡æ–™ï¼ˆä»¥å°ä¸­ä¸­å¿ƒé»è¨ˆç®—ï¼‰
            fetchBikeData(24.1373, 120.6869);
        }, { enableHighAccuracy: true });
    }

    // 3. é€éä½ çš„ GAS ç¶²å€æŠ“å– YouBike è³‡æ–™
    async function fetchBikeData(uLat, uLng) {
        document.getElementById("status").innerText = "æ­£åœ¨é€é Google ä¸­ç¹¼ç«™åŒæ­¥ API è³‡æ–™...";
        
        // é€™æ˜¯ä½ æä¾›çš„ GAS URL (å·²è£œä¸Šå®Œæ•´çš„æ‡‰ç”¨ç¨‹å¼è·¯å¾‘)
        const gasUrl = "https://script.google.com/macros/s/AKfycbxNXKOcsM4RcRk08mulPvcbf3kPNO554qUYcsH55YU/exec"; 
        
        try {
            const res = await fetch(gasUrl);
            const data = await res.json();
            
            // è‡ªå‹•åµæ¸¬è³‡æ–™æ ¼å¼ (é™£åˆ—æˆ–ç‰©ä»¶)
            let rawStations = [];
            if (Array.isArray(data)) {
                rawStations = data;
            } else if (data && data.retVal) {
                rawStations = Array.isArray(data.retVal) ? data.retVal : Object.values(data.retVal);
            }

            if (rawStations.length === 0) {
                document.getElementById("status").innerText = "æŠ“åˆ°è³‡æ–™ä½†å…§å®¹ç‚ºç©ºï¼Œè«‹ç¨å¾Œå†è©¦";
                return;
            }

            // è¨ˆç®—è·é›¢ä¸¦ç”±è¿‘åˆ°é æ’åº
            let stations = rawStations
                .filter(s => s.lat && s.lng)
                .map(s => ({
                    ...s,
                    latNum: parseFloat(s.lat),
                    lngNum: parseFloat(s.lng),
                    dist: getDistance(uLat, uLng, parseFloat(s.lat), parseFloat(s.lng))
                }))
                .sort((a, b) => a.dist - b.dist);

            renderUI(stations);
            document.getElementById("status").innerText = `æœ€å¾Œæ›´æ–°ï¼š${new Date().toLocaleTimeString()} (å…±æ‰¾åˆ° ${stations.length} ç«™)`;
            
        } catch (e) {
            document.getElementById("status").innerText = "é€šè¨ŠéŒ¯èª¤ï¼šç„¡æ³•é€£æ¥è‡³ Google ä¸­ç¹¼ç«™ï¼Œè«‹ç¢ºèªéƒ¨ç½²è¨­å®š";
            console.error(e);
        }
    }

    // 4. æ¸²æŸ“åœ°åœ–æ¨™è¨˜èˆ‡ä¸‹æ–¹åˆ—è¡¨
    function renderUI(stations) {
        stationGroup.clearLayers();
        const listDiv = document.getElementById("side-list");
        listDiv.innerHTML = "";

        // åœ¨åœ°åœ–ä¸Šæ¨™ç¤ºæœ€è¿‘çš„ 30 å€‹ç«™é»
        stations.slice(0, 30).forEach((s, index) => {
            const isNear = index < 5; // å‰ 5 åä½œç‚ºæ¸…å–®æ¨è–¦
            const marker = L.circleMarker([s.latNum, s.lngNum], {
                radius: isNear ? 10 : 7,
                fillColor: s.sbi > 0 ? "#28a745" : "#dc3545",
                color: "#fff",
                weight: 2,
                fillOpacity: 0.9
            }).addTo(stationGroup);

            marker.bindPopup(`<b>${s.sna.replace('YouBike2.0_', '')}</b><br>å¯å€Ÿè»Šè¼›ï¼š${s.sbi}<br>å¯é‚„ç©ºä½ï¼š${s.bemp}`);

            // å»ºç«‹ä¸‹æ–¹æ¨è–¦æ¸…å–®
            if (isNear) {
                const card = document.createElement('div');
                card.className = 'station-card';
                card.innerHTML = `
                    <div>
                        <div style="font-weight:bold; color:#333;">${s.sna.replace('YouBike2.0_', '')}</div>
                        <div class="dist-text">ğŸ“ è·é›¢ç´„ ${(s.dist).toFixed(2)} å…¬é‡Œ</div>
                    </div>
                    <div class="bike-num ${s.sbi == 0 ? 'bike-empty' : ''}">${s.sbi}</div>
                `;
                // é»æ“Šå¡ç‰‡åœ°åœ–æœƒè‡ªå‹•é£›éå»
                card.onclick = () => {
                    map.setView([s.latNum, s.lngNum], 18);
                    marker.openPopup();
                };
                listDiv.appendChild(card);
            }
        });
    }

    // ç¶²é è¼‰å…¥å¾Œå•Ÿå‹•
    window.onload = init;
</script>
</body>
</html>
