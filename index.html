<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouBike 2.0 æ‰¾è»Šåœ°åœ–</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        html, body { height: 100%; margin: 0; font-family: sans-serif; }
        .container { display: flex; flex-direction: column; height: 100%; }
        #map { flex: 1; z-index: 1; }
        #list-container { height: 40%; overflow-y: auto; background: white; border-top: 3px solid #ffef00; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #ffef00; position: sticky; top: 0; padding: 10px; z-index: 10; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        .available { color: green; font-weight: bold; }
        .empty { color: red; font-weight: bold; }
        
        /* è©¢å•å±¤ */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 9999;
        }
        .start-btn {
            padding: 15px 40px; font-size: 1.2rem; cursor: pointer;
            background: #ffef00; border: 2px solid #000; border-radius: 50px;
        }
    </style>
</head>
<body>

<div id="overlay">
    <h2>ğŸš² YouBike 2.0 å³æ™‚æŸ¥è©¢</h2>
    <p>é»æ“ŠæŒ‰éˆ•æˆæ¬Šå®šä½ï¼Œå°‹æ‰¾æœ€è¿‘ç«™é»</p>
    <button class="start-btn" onclick="startApp()">é–‹å§‹å®šä½ä¸¦æŸ¥è©¢</button>
</div>

<div class="container">
    <div id="map"></div>
    <div id="list-container">
        <table>
            <thead>
                <tr><th>ç«™é»</th><th>è·é›¢</th><th>å¯å€Ÿ</th><th>å¯é‚„</th></tr>
            </thead>
            <tbody id="bikeList"></tbody>
        </table>
    </div>
</div>

<script>
const map = L.map('map').setView([25.033, 121.565], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

function startApp() {
    document.getElementById('overlay').style.display = 'none';
    
    navigator.geolocation.getCurrentPosition(async (pos) => {
        const { latitude: lat, longitude: lng } = pos.coords;
        L.marker([lat, lng]).addTo(map).bindPopup("æ‚¨åœ¨æ­¤è™•").openPopup();
        map.setView([lat, lng], 16);
        await fetchBikeData(lat, lng);
    }, (err) => {
        alert("å®šä½å¤±æ•—ï¼š" + err.message + "\nè«‹ç¢ºèªæ˜¯å¦é–‹å•Ÿ GPS ä¸¦ä½¿ç”¨ HTTPS é€£ç·šã€‚");
    });
}

async function fetchBikeData(uLat, uLng) {
    const tbody = document.getElementById('bikeList');
    tbody.innerHTML = '<tr><td colspan="4">æ­£åœ¨åŠªåŠ›é€£ç·šä¸­...</td></tr>';

    // å˜—è©¦å¤šç¨®ä»£ç†æ–¹å¼ä»¥ç¢ºä¿æˆåŠŸ
    const target = "https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json";
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(target)}&timestamp=${new Date().getTime()}`;

    try {
        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error("ä»£ç†ä¼ºæœå™¨å›æ‡‰ç•°å¸¸");
        
        const resData = await response.json();
        // æª¢æŸ¥ contents æ˜¯å¦å­˜åœ¨
        if (!resData.contents) throw new Error("æ‰¾ä¸åˆ°è³‡æ–™å…§å®¹");
        
        const data = JSON.parse(resData.contents);

        const stations = data.map(s => ({
            name: s.sna.replace("YouBike2.0_", ""),
            lat: s.lat, lng: s.lng,
            available: s.sbi, empty: s.bemp,
            dist: getDistance(uLat, uLng, s.lat, s.lng)
        }))
        .sort((a, b) => a.dist - b.dist)
        .slice(0, 20);

        tbody.innerHTML = "";
        stations.forEach(s => {
            L.marker([s.lat, s.lng]).addTo(map)
                .bindPopup(`<b>${s.name}</b><br>å¯å€Ÿï¼š${s.available}`);

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align:left">${s.name}</td>
                <td>${Math.round(s.dist)}m</td>
                <td class="${s.available > 0 ? 'available' : 'empty'}">${s.available}</td>
                <td>${s.empty}</td>
            `;
            tbody.appendChild(tr);
        });

    } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="4" style="color:red">é€£ç·šå¤±æ•—ï¼åŸå› ï¼š${err.message}<br>è«‹é‡æ–°æ•´ç†æˆ–æª¢æŸ¥ç¶²è·¯è¨­å®šã€‚</td></tr>`;
    }
}

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
</script>
</body>
</html>
