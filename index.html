<!DOCTYPE HTML>
<html>
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
Â  <title>å°ä¸­ YouBike 2.0 å°èˆª (TDXä¿®æ­£ç‰ˆ)</title>
Â  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
Â  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
Â  <style>
Â  Â  body { margin: 0; font-family: system-ui, sans-serif; display: flex; flex-direction: column; height: 100vh; background: #f0f2f5; }
Â  Â  #bar { padding: 12px; background: white; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
Â  Â  #map { flex: 1; width: 100%; }
Â  Â  #list-container { height: 260px; overflow-y: auto; background: white; border-top: 3px solid #28a745; z-index: 1001; }
Â  Â  .list-item { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #eee; align-items: center; cursor: pointer; }
Â  Â  .list-item:active { background: #f1f3f4; }
Â  Â  .list-name { font-weight: bold; font-size: 16px; color: #333; }
Â  Â  .bike-num { font-size: 24px; font-weight: bold; }
Â  Â  button#btn { padding: 10px 20px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
Â  Â  .popup-flex { display: flex; align-items: stretch; min-height: 100px; width: 250px; }
Â  Â  .nav-btn-right { width: 80px; background: #4285f4; color: white !important; display: flex; flex-direction: column; justify-content: center; align-items: center; text-decoration: none; border-left: 1px solid #eee; font-weight: bold; }
Â  </style>
</head>
<body>
Â  <div id="bar">
Â  Â  <button id="btn" onclick="startApp()">ğŸ” å°‹æ‰¾é™„è¿‘ç«™é»</button>
Â  Â  <div id="status" style="font-size: 12px; color: #666;">ç­‰å¾…å®šä½...</div>
Â  </div>
Â  <div id="map"></div>
Â  <div id="list-container"><div style="padding:40px; text-align:center; color:#999;">å•Ÿå‹•å¾Œè‡ªå‹•é¡¯ç¤º 2km å…§æ’åºæ¸…å–®</div></div>

Â  <script>
Â  Â  // ğŸ”´ æ”¹ç”¨ corsproxy.ioï¼Œé€Ÿåº¦é€šå¸¸æ¯”è¼ƒå¿«ä¸”ç©©å®š
Â  Â  const PROXY = "https://corsproxy.io/?";
Â  Â Â 
Â  Â  const API_AVAIL = "https://tdx.transportdata.tw/api/basic/v2/Bike/Availability/City/Taichung?%24format=JSON";
Â  Â  const API_STATION = "https://tdx.transportdata.tw/api/basic/v2/Bike/Station/City/Taichung?%24format=JSON";

Â  Â  let map, userPos, userMarker, stationGroup, markers = {};

Â  Â  function initMap(lat, lon) {
Â  Â  Â  if (map) return;
Â  Â  Â  map = L.map("map", { zoomControl: false }).setView([lat, lon], 16);
Â  Â  Â  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
Â  Â  Â  Â  attribution: 'Â© OpenStreetMap'
Â  Â  Â  }).addTo(map);
Â  Â  Â  stationGroup = L.layerGroup().addTo(map);
Â  Â  }

Â  Â  async function startApp() {
Â  Â  Â  const status = document.getElementById("status");
Â  Â  Â  status.innerText = "ğŸ“ å®šä½ä¸­...";
Â  Â  Â Â 
Â  Â  Â  navigator.geolocation.getCurrentPosition(async (pos) => {
Â  Â  Â  Â  userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
Â  Â  Â  Â  initMap(userPos.lat, userPos.lng);
Â  Â  Â  Â  map.setView([userPos.lat, userPos.lng], 16);

Â  Â  Â  Â  if (userMarker) userMarker.remove();
Â  Â  Â  Â  userMarker = L.circleMarker([userPos.lat, userPos.lng], {
Â  Â  Â  Â  Â  radius: 8, color: 'white', weight: 2, fillColor: '#4285f4', fillOpacity: 1
Â  Â  Â  Â  }).addTo(map);

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  status.innerText = "ğŸ“¡ é€£ç·šä¸­ (corsproxy)...";
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const [stRes, avRes] = await Promise.all([
Â  Â  Â  Â  Â  Â  fetch(PROXY + encodeURIComponent(API_STATION)),
Â  Â  Â  Â  Â  Â  fetch(PROXY + encodeURIComponent(API_AVAIL))
Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // ğŸ”´ ä¿®æ­£é»ï¼šcorsproxy æœƒç›´æ¥å›å‚³åŸå§‹ JSONï¼Œä¸éœ€è¦å†è§£ä¸€æ¬¡ .contents
Â  Â  Â  Â  Â  const stData = await stRes.json();
Â  Â  Â  Â  Â  const avData = await avRes.json();

Â  Â  Â  Â  Â  const avMap = {};
Â  Â  Â  Â  Â  // ç¢ºä¿è³‡æ–™æ˜¯é™£åˆ— (æœ‰æ™‚å€™ TDX éŒ¯èª¤æœƒå›å‚³ç‰©ä»¶)
Â  Â  Â  Â  Â  if (Array.isArray(avData)) {
Â  Â  Â  Â  Â  Â  avData.forEach(a => avMap[a.StationUID] = a);
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  renderUI(stData, avMap);
Â  Â  Â  Â  Â  status.innerText = "âœ… æ›´æ–°æˆåŠŸ";
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  status.innerText = "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
Â  Â  Â  Â  }
Â  Â  Â  }, (err) => {
Â  Â  Â  Â  status.innerText = "âŒ å®šä½å¤±æ•—";
Â  Â  Â  Â  alert("éœ€è¦å®šä½æ¬Šé™");
Â  Â  Â  }, { enableHighAccuracy: true, timeout: 10000 });
Â  Â  }

Â  Â  function renderUI(stData, avMap) {
Â  Â  Â  const listEl = document.getElementById("list-container");
Â  Â  Â  listEl.innerHTML = "";
Â  Â  Â  stationGroup.clearLayers();

Â  Â  Â  if (!Array.isArray(stData)) return; // éŒ¯èª¤é˜²è­·

Â  Â  Â  const nearby = stData.map(s => {
Â  Â  Â  Â  const av = avMap[s.StationUID] || { AvailableRentBikes: 0 };
Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  uid: s.StationUID,
Â  Â  Â  Â  Â  name: s.StationName.Zh_tw.replace('YouBike2.0_', ''),
Â  Â  Â  Â  Â  lat: s.StationPosition.PositionLat,
Â  Â  Â  Â  Â  lng: s.StationPosition.PositionLon,
Â  Â  Â  Â  Â  bikes: av.AvailableRentBikes,
Â  Â  Â  Â  Â  dist: map.distance([userPos.lat, userPos.lng], [s.StationPosition.PositionLat, s.StationPosition.PositionLon])
Â  Â  Â  Â  };
Â  Â  Â  }).filter(s => s.dist < 2000).sort((a, b) => a.dist - b.dist);

Â  Â  Â  if (nearby.length === 0) {
Â  Â  Â  Â  listEl.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">é™„è¿‘ç„¡ç«™é»</div>';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  nearby.forEach(s => {
Â  Â  Â  Â  const hex = s.bikes > 5 ? '#28a745' : (s.bikes > 0 ? '#e67e22' : '#dc3545');
Â  Â  Â  Â  const colorName = s.bikes > 5 ? 'green' : (s.bikes > 0 ? 'orange' : 'red');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const marker = L.marker([s.lat, s.lng], {
Â  Â  Â  Â  Â  icon: L.icon({
Â  Â  Â  Â  Â  Â  iconUrl: `https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${colorName}.png`,
Â  Â  Â  Â  Â  Â  iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  }).addTo(stationGroup);

Â  Â  Â  Â  // ä½¿ç”¨ Google Maps é€šç”¨å”è­°é€£çµ
Â  Â  Â  Â  const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}&travelmode=walking`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  marker.bindPopup(`
Â  Â  Â  Â  Â  <div class="popup-flex">
Â  Â  Â  Â  Â  Â  <div style="padding:15px;flex:1;">
Â  Â  Â  Â  Â  Â  Â  <b>${s.name}</b><br>
Â  Â  Â  Â  Â  Â  Â  è»Šè¼›: <span style="color:${hex}; font-weight:bold;">${s.bikes}</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <a href="${navUrl}" target="_blank" class="nav-btn-right">ğŸ§­<br>å°èˆª</a>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `);
Â  Â  Â  Â  markers[s.uid] = marker;

Â  Â  Â  Â  const item = document.createElement("div");
Â  Â  Â  Â  item.className = "list-item";
Â  Â  Â  Â  item.innerHTML = `
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div class="list-name">${s.name}</div>
Â  Â  Â  Â  Â  Â  <div style="font-size:12px;color:#666;">${Math.round(s.dist)} å…¬å°º</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="bike-num" style="color:${hex}">${s.bikes}</div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  item.onclick = () => {
Â  Â  Â  Â  Â  map.flyTo([s.lat, s.lng], 18);
Â  Â  Â  Â  Â  setTimeout(() => markers[s.uid].openPopup(), 400);
Â  Â  Â  Â  };
Â  Â  Â  Â  listEl.appendChild(item);
Â  Â  Â  });
Â  Â  }
Â  </script>
</body>
</html>
