<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>台中 YouBike 2.0 即時地圖</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, sans-serif; }
    #bar { padding: 12px; background: white; z-index: 1000; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    #map { height: 100vh; width: 100%; position: absolute; top: 0; left: 0; }
    button { padding: 10px 15px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; position: relative; z-index: 1001; }
    #msg { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1001; background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; pointer-events: none; }
  </style>
</head>

<body>
  <div id="bar">
    <button id="btn">尋找附近 YouBike</button>
  </div>
  <div id="map"></div>
  <div id="msg">請點擊按鈕開始定位</div>

  <script>
    const API_URL = "https://ybjson02.youbike.com.tw:60008/yb2/taichung/gwjs.json";
    let map, userMarker, accCircle, stationGroup;

    function show_msg(text) {
      document.getElementById("msg").textContent = text;
    }

    // 初始化地圖
    function initMap(lat, lon) {
      map = L.map("map").setView([lat, lon], 16);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
      }).addTo(map);
      stationGroup = L.layerGroup().addTo(map);
    }

    // 核心修復：利用動態 Script 標籤載入資料 (免 CORS / 免 Proxy)
    function loadYouBikeData() {
      return new Promise((resolve, reject) => {
        const oldScript = document.getElementById('ubike-data');
        if (oldScript) oldScript.remove();

        const script = document.createElement('script');
        script.id = 'ubike-data';
        script.src = `${API_URL}?t=${Date.now()}`;
        
        script.onload = () => {
          if (typeof gwjs !== 'undefined') resolve(gwjs.retVal);
          else reject(new Error("資料解析失敗"));
        };
        script.onerror = () => reject(new Error("無法連線至 YouBike 伺服器 (可能是 Port 60008 被封鎖)"));
        
        document.body.appendChild(script);
      });
    }

    async function start() {
      show_msg("正在定位中...");
      
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const { latitude: uLat, longitude: uLon, accuracy: uAcc } = pos.coords;

        if (!map) initMap(uLat, uLon);
        map.setView([uLat, uLon], 16);

        // 使用者位置標記
        if (!userMarker) userMarker = L.marker([uLat, uLon]).addTo(map).bindPopup("您的位置");
        userMarker.setLatLng([uLat, uLon]);

        show_msg("正在獲取 YouBike 即時資料...");

        try {
          const stations = await loadYouBikeData();
          stationGroup.clearLayers();

          Object.values(stations).forEach(s => {
            const sLat = parseFloat(s.lat), sLon = parseFloat(s.lng);
            const dist = map.distance([uLat, uLon], [sLat, sLon]);

            if (dist < 1000) { // 只顯示 1 公里內
              L.marker([sLat, sLon], {
                icon: L.icon({
                  iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                  iconSize: [25, 41], iconAnchor: [12, 41]
                })
              }).bindPopup(`<b>${s.sna.replace('YouBike2.0_', '')}</b><br>可借：${s.sbi}<br>空位：${s.bemp}`)
                .addTo(stationGroup);
            }
          });
          show_msg("更新完成！");
        } catch (err) {
          show_msg(err.message);
        }
      }, (err) => {
        show_msg("定位失敗，請確認 GPS 已開啟");
      }, { enableHighAccuracy: true });
    }

    document.getElementById("btn").addEventListener("click", start);
  </script>
</body>
</html>
