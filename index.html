<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é™„è¿‘ YouBikeï¼ˆè‡ªå‹•æ’åºï¼‰</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  html, body { height: 100%; margin: 0; font-family: sans-serif; }
  .container { display: flex; height: 100%; flex-direction: column; }
  #map { flex: 1; }
  #list { height: 35%; overflow-y: auto; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
  th { background: #f4f4f4; position: sticky; top: 0; }
  tr:hover { background-color: #f9f9f9; }
</style>
</head>
<body>
<div class="container">
  <div id="map"></div>
  <div id="list">
    <table id="bikeTable">
      <thead>
        <tr>
          <th>ç«™é»åç¨±</th>
          <th>è·é›¢ (å…¬å°º)</th>
        </tr>
      </thead>
      <tbody id="bikeList">
        <tr><td colspan="2" style="text-align:center;">å®šä½ä¸­ä¸¦è®€å–è³‡æ–™...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
// 1. è·é›¢è¨ˆç®—å‡½æ•¸
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

const map = L.map('map').setView([25.0330, 121.5654], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);

navigator.geolocation.getCurrentPosition(async (pos) => {
  const userLat = pos.coords.latitude;
  const userLng = pos.coords.longitude;

  L.marker([userLat, userLng], {title: "ä½ åœ¨æ­¤"}).addTo(map).bindPopup("<b>ğŸ“ ä½ çš„ä½ç½®</b>").openPopup();
  map.setView([userLat, userLng], 16);

  try {
    // 2. å‘¼å«å°åŒ—å¸‚ YouBike 2.0 ç«™é»è³‡æ–™ (V2 èˆŠç¶²å€å¯èƒ½å¤±æ•ˆ)
    // è¨»ï¼šè‹¥åœ¨æ­£å¼ç’°å¢ƒï¼Œéœ€åŠ å…¥ TDX Authorization Header
    const response = await fetch("https://ptx.transportdata.tw/MOTC/v2/Bike/Station/Taipei?$format=JSON");
    
    if (!response.ok) throw new Error("API é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™");
    
    const data = await response.json();
    const tbody = document.getElementById("bikeList");
    tbody.innerHTML = "";

    // 3. è¨ˆç®—è·é›¢ä¸¦æ’åº
    const sortedData = data.map(station => ({
      ...station,
      distance: getDistance(userLat, userLng, station.StationPosition.PositionLat, station.StationPosition.PositionLon)
    })).sort((a, b) => a.distance - b.distance);

    // 4. åªå–æœ€è¿‘çš„ 20 ç«™ï¼Œé¿å…åœ°åœ–å¡æ»¿æ¨™è¨˜
    sortedData.slice(0, 20).forEach(station => {
      const name = station.StationName.Zh_tw.replace("YouBike2.0_", "");
      
      // æ·»åŠ åœ°åœ–é»
      L.marker([station.StationPosition.PositionLat, station.StationPosition.PositionLon])
        .addTo(map)
        .bindPopup(`<b>${name}</b><br>è·é›¢: ${Math.round(station.distance)}å…¬å°º`);

      // æ·»åŠ åˆ°åˆ—è¡¨
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${name}</td><td>${Math.round(station.distance)} m</td>`;
      tbody.appendChild(tr);
    });

  } catch (error) {
    console.error(error);
    document.getElementById("bikeList").innerHTML = `<tr><td colspan="2">éŒ¯èª¤: ${error.message}</td></tr>`;
  }

}, (err) => {
  alert("ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹ç¢ºèªæ˜¯å¦é–‹å•Ÿ GPS ä¸¦å…è¨±ç€è¦½å™¨å®šä½ã€‚");
});
</script>
</body>
</html>
